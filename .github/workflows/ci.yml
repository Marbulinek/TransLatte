name: CI/CD Pipeline

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [14.x, 16.x, 18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linter
      run: npm run lint --if-present
    
    - name: Build project
      run: npm run build
    
    - name: Run tests
      run: npm test
    
    - name: Check build artifacts
      run: |
        if [ ! -d "dist" ]; then
          echo "Build failed: dist directory not found"
          exit 1
        fi
        if [ ! -f "dist/cli.js" ]; then
          echo "Build failed: cli.js not found"
          exit 1
        fi
        echo "Build successful: All artifacts present"

  version-and-publish:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org'
    
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build
      run: npm run build
    
    - name: Check if version bump needed
      id: check_version
      run: |
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
        
        # Check if last commit was a version bump (to avoid duplicate bumps)
        if [[ "$LAST_COMMIT_MSG" == *"chore(release):"* ]]; then
          echo "skip=true" >> $GITHUB_OUTPUT
          echo "Last commit was a version bump, skipping..."
        else
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "Version bump needed for version $CURRENT_VERSION"
        fi
    
    - name: Determine version bump type
      id: bump_type
      if: steps.check_version.outputs.skip == 'false'
      run: |
        LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
        
        if [[ "$LAST_COMMIT_MSG" == *"BREAKING CHANGE"* ]] || [[ "$LAST_COMMIT_MSG" == *"major:"* ]]; then
          echo "type=major" >> $GITHUB_OUTPUT
          echo "Bumping major version (breaking change detected)"
        elif [[ "$LAST_COMMIT_MSG" == *"feat:"* ]] || [[ "$LAST_COMMIT_MSG" == *"feature:"* ]]; then
          echo "type=minor" >> $GITHUB_OUTPUT
          echo "Bumping minor version (feature detected)"
        else
          echo "type=patch" >> $GITHUB_OUTPUT
          echo "Bumping patch version (default)"
        fi
    
    - name: Bump version
      if: steps.check_version.outputs.skip == 'false'
      run: |
        npm version ${{ steps.bump_type.outputs.type }} -m "chore(release): bump version to %s [skip ci]"
    
    - name: Push version bump and tags
      if: steps.check_version.outputs.skip == 'false'
      run: |
        git push origin ${{ github.ref_name }}
        git push --tags
    
    - name: Publish to npm
      if: steps.check_version.outputs.skip == 'false'
      run: npm publish --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
